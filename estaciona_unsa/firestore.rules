rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isGuard() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guard';
    }
    
    function isGuardOrAdmin() {
      return isGuard() || isAdmin();
    }
    
    function isUNSAEmail(email) {
      return email.matches('.*@unsa.edu.pe$');
    }

    // ===== USERS =====
    match /users/{userId} {
      // Anyone authenticated can read their own profile
      allow read: if isOwner(userId) || isGuardOrAdmin();
      
      // Create: Only if authenticated and email is @unsa.edu.pe
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && isUNSAEmail(request.resource.data.email)
        && !exists(/databases/$(database)/documents/users/$(userId));
      
      // Update: Only owner can update their own data (except role and stats)
      allow update: if isOwner(userId) 
        && request.resource.data.role == resource.data.role
        && request.resource.data.email == resource.data.email;
      
      // Delete: Never allow from client
      allow delete: if false;
    }

    // ===== CAMPUS =====
    match /campus/{campusId} {
      // Everyone authenticated can read campus info
      allow read: if isAuthenticated();
      
      // Only admins can create/update/delete campus
      allow write: if isAdmin();
    }

    // ===== PARKING ZONES =====
    match /parking_zones/{zoneId} {
      // Anyone authenticated can read zones
      allow read: if isAuthenticated();
      
      // Only admins can create/update/delete zones
      // Validate that campusId exists when creating
      allow create: if isAdmin() 
        && exists(/databases/$(database)/documents/campus/$(request.resource.data.campusId));
      
      allow update, delete: if isAdmin();
    }

    // ===== PARKING SPOTS =====
    match /parking_spots/{spotId} {
      // Anyone authenticated can read spots
      allow read: if isAuthenticated();
      
      // Users can update spots when:
      // 1. Reserving (available → reserved)
      // 2. Cancelling (reserved → available)
      // 3. Arriving/Using (reserved → occupied) - "Ya me estacioné"
      // 4. Leaving (occupied → available) - "Ya me salí"
      // Guards and admins can update spots freely
      allow update: if isAuthenticated() && (
        // 1. User reserving: available → reserved
        (resource.data.status == 'available' && 
         request.resource.data.status == 'reserved' &&
         request.resource.data.currentOccupancy != null &&
         request.resource.data.currentOccupancy.userId == request.auth.uid) ||
        
        // 2. User cancelling reservation: reserved → available
        // Must be the owner of the reservation
        (resource.data.status == 'reserved' &&
         request.resource.data.status == 'available' &&
         resource.data.currentOccupancy != null &&
         resource.data.currentOccupancy.userId == request.auth.uid) ||
        
        // 3. User arriving (Ya me estacioné): reserved → occupied
        // Must be the owner and have a valid reservationId
        (resource.data.status == 'reserved' &&
         request.resource.data.status == 'occupied' &&
         resource.data.currentOccupancy != null &&
         resource.data.currentOccupancy.userId == request.auth.uid &&
         request.resource.data.currentOccupancy.reservationId != null) ||
        
        // 4. User leaving (Ya me salí): occupied → available
        // Just needs to have a valid reservationId (security through reservation ownership)
        (resource.data.status == 'occupied' &&
         request.resource.data.status == 'available' &&
         resource.data.currentOccupancy != null &&
         resource.data.currentOccupancy.reservationId != null) ||
        
        // Guards and admins can update any spot freely
        isGuardOrAdmin()
      );
      
      // Only admins can create/delete spots
      allow create, delete: if isAdmin();
    }

    // ===== RESERVATIONS =====
    match /reservations/{reservationId} {
      // Users can read their own reservations, guards/admins can read all
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isGuardOrAdmin());
      
      // Users can create reservations for themselves
      // Must be in 'active' status initially
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.status == 'active';
      
      // Users can update their own reservations
      // Allowed status changes:
      // - active → cancelled (user cancels before arriving)
      // - active → used (user arrives - "Ya me estacioné")
      // - used → completed (user leaves - "Ya me salí")
      // - active → expired (system auto-expires)
      allow update: if isAuthenticated() && (
        // User owns the reservation and is changing to valid status
        (resource.data.userId == request.auth.uid &&
         request.resource.data.status in ['cancelled', 'used', 'completed', 'expired']) ||
        // Or is guard/admin (can do anything)
        isGuardOrAdmin()
      );
      
      // No one can delete reservations from client (for audit trail)
      allow delete: if false;
    }

    // ===== ENTRY/EXIT LOGS =====
    match /entry_exit_logs/{logId} {
      // Users can read their own logs, guards/admins can read all
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isGuardOrAdmin());
      
      // Only guards and admins can create logs
      allow create: if isGuardOrAdmin() 
        && request.resource.data.guardId == request.auth.uid;
      
      // Only admins can update logs
      allow update: if isAdmin();
      
      // No one can delete logs (for audit trail)
      allow delete: if false;
    }

    // ===== INCIDENTS =====
    match /incidents/{incidentId} {
      // Users can read incidents involving them, guards/admins can read all
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isGuardOrAdmin());
      
      // Guards and admins can create incidents
      allow create: if isGuardOrAdmin() 
        && request.resource.data.reportedBy == request.auth.uid;
      
      // Only admins can update/resolve incidents
      allow update: if isAdmin();
      
      // No one can delete incidents (for audit trail)
      allow delete: if false;
    }

    // ===== APP SETTINGS =====
    match /app_settings/{settingId} {
      // Everyone authenticated can read settings
      allow read: if isAuthenticated();
      
      // Only admins can write settings
      allow write: if isAdmin();
    }

    // ===== NOTIFICATIONS =====
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Users can update their own notifications (only mark as read)
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasOnly(['isRead', 'updatedAt']);
      
      // System/admins can create notifications
      allow create: if isGuardOrAdmin();
      
      // No one can delete notifications from client
      allow delete: if false;
    }
  }
}
